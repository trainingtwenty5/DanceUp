<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drzewko Umiejętności Breaking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  /* Kolory bazowe */
  --bg: #0d1117;               /* główne tło */
  --panel: #161b22;            /* panele/kafelki */
  --text: #e6edf3;             /* podstawowy tekst */
  --muted: #8b949e;            /* tekst poboczny */
  --accent: #00d4ff;           /* akcent główny */
  --accent-2: #4df0b8;         /* akcent gradientowy */
  --danger: #ff6b6b;

  /* Poziomy umiejętności */
  --level0: #30363d;           /* zablokowane */
  --level1: #f1c40f;           /* złoty */
  --level2: #2ecc71;           /* zielony */
  --level3: #9b59b6;           /* fioletowy */

  /* Łączniki */
  --connector: #00d4ff;

  /* Style ogólne */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.35);
  --transition: all 0.3s ease;
}

/* Reset */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', 'SF Pro Text', Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  padding: 20px;
  overflow-x: hidden;
  min-height: 100vh;
  transform: scale(0.85);
  transform-origin: top center;
}

/* Kontenery */
.container { max-width: 1400px; margin: 0 auto; }
header { text-align: center; margin-bottom: 30px; }

/* Nagłówki */
h1 {
  font-size: 2.5rem;
  font-weight: 800;
  margin-bottom: 10px;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.subtitle {
  font-size: 1.1rem;
  color: var(--muted);
}

/* Ekran logowania */
.auth-container {
  max-width: 400px;
  margin: 100px auto;
  padding: 30px;
  background: var(--panel);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
}

.auth-container h2 { text-align: center; margin-bottom: 20px; }

.auth-input {
  width: 100%;
  padding: 12px 14px;
  margin-bottom: 15px;
  border-radius: var(--radius-lg);
  border: 1px solid #30363d;
  background: #0d1117;
  color: var(--text);
  font-size: 1rem;
  transition: var(--transition);
}

.auth-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
}

.auth-button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: var(--radius-lg);
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #000;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.auth-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.auth-switch {
  text-align: center;
  margin-top: 20px;
  color: var(--muted);
  cursor: pointer;
  transition: var(--transition);
}
.auth-switch:hover { color: var(--accent); }

.error-message { color: var(--danger); text-align: center; font-size: 14px; }

/* Panel użytkownika */
.user-panel {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--panel);
  padding: 15px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-width: 200px;
}

.user-info { display: flex; align-items: center; gap: 10px; }

.user-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  display: flex; align-items: center; justify-content: center;
  font-weight: bold; color: #000;
}

.user-name { font-weight: 600; }

.progress-bar {
  height: 6px; background: #30363d;
  border-radius: 3px; overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  transition: width 0.4s ease;
}
.progress-text { font-size: 0.8rem; color: var(--muted); text-align: center; }

.logout-btn {
  padding: 8px;
  border: none;
  border-radius: var(--radius-md);
  background: #21262d;
  color: var(--text);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}
.logout-btn:hover { background: #30363d; }

/* Drzewko umiejętności */
.skill-tree {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2rem 0;
}
.tree-axis {
  position: absolute;
  top: 0; bottom: 0;
  width: 3px;
  background: var(--connector);
  left: 50%; transform: translateX(-50%);
}

.tree-level {
  display: flex;
  justify-content: center;
  position: relative;
  margin: 60px 0;
  gap: 30px;
}

/* Główne kafelki */
.main-skill, .branch-skill {
  padding: 12px 16px;
  min-width: 130px;
  text-align: center;
  border-radius: var(--radius-lg);
  background: var(--panel);
  border: 1px solid #30363d;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: var(--transition);
}
.main-skill:hover, .branch-skill:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}

/* Poziomy */
.main-skill.level0, .branch-skill.level0 { background: var(--level0); }
.main-skill.level1, .branch-skill.level1 { background: var(--level1); color: #000; }
.main-skill.level2, .branch-skill.level2 { background: var(--level2); }
.main-skill.level3, .branch-skill.level3 { background: var(--level3); }

/* Łączniki */
.branch {
  display: flex; align-items: center;
  gap: 30px; position: relative;
}
.branch::before {
  content: ""; position: absolute; top: 50%;
  width: 80px; height: 2px;
  background: var(--connector);
}

/* Mini-video */
.branch-skill.mini-video {
  background: #21262d;
  border: 1px solid #30363d;
  padding: 6px;
}
.branch-skill.mini-video:hover { background: #2a2f3a; }

/* Progress gałęzi */
.branch-progress {
  margin-top: 8px;
  font-size: 0.8rem;
  background: #21262d;
  padding: 4px 8px;
  border-radius: var(--radius-md);
  color: var(--muted);
}

/* Grywalizacja */
.user-card {
  background: var(--panel);
  border: 1px solid #30363d;
  border-radius: var(--radius-lg);
  padding: 15px;
  transition: var(--transition);
}
.user-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

/* Responsywność */
@media (max-width: 768px) {
  .tree-level { flex-direction: column; }
  .user-panel { position: relative; margin: 0 auto 20px; }
}






.branch-skill.level0 {
  color: #777;          /* szary kolor ikony */
  font-size: 24px;      /* większa kłódka */
}
.branch-skill.level0 i {
  margin: 0;            /* usuń odstępy */
}
.hidden {
  display: none !important;
}

</style>





</head>
<body>
  <!-- Ekran logowania -->
  <div id="auth-container" class="auth-container">
    <h2 style="color:white">Logowanie do Umiejętności Breaking</h2>
    <div id="login-form">
      <input type="email" id="login-email" class="auth-input" placeholder="Adres email">
      <input type="password" id="login-password" class="auth-input" placeholder="Hasło">
      <div id="login-error" class="error-message"></div>
      <button id="login-btn" style="color:black" class="auth-button">Zaloguj się</button>
      <div class="auth-switch" style="color:white" id="show-register">Nie masz konta? Zarejestruj się</div>
    </div>
    
    <div id="register-form" style="display: none;">
      <input type="text" id="register-name" class="auth-input" placeholder="Imię i nazwisko">
      <input type="email" id="register-email" class="auth-input" placeholder="Adres email">
      <input type="password" id="register-password" class="auth-input" placeholder="Hasło (min. 6 znaków)">
      <div id="register-error" class="error-message"></div>
      <button id="register-btn" class="auth-button" style="color:white">Zarejestruj się</button>
      <div class="auth-switch" id="show-login" style="color:white">Masz już konto? Zaloguj się</div>
    </div>
  </div>

  <!-- Główna aplikacja -->
  <div id="app-container" class="app-container">
    <div class="container">
      <header>
        <h1>Zdobyte umiejętności Breakingu</h1>
        <p style="text-align:center; color:#fff; margin-bottom:10px; font-weight:500;">
          Kliknij w kategorię, aby zobaczyć zdobyte umiejętności
        </p>
      </header>
      
      <div class="skill-tree" id="skillTree">
        <div class="tree-axis"></div>
        <!-- Drzewko będzie generowane dynamicznie -->
      </div>
    </div>
    
    <div class="user-panel">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-name" id="userName">Użytkownik</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">0/25 umiejętności</div>
      <!-- W user-panel, pod logout-btn -->
      <button class="logout-btn" id="gamificationBtn" >Grywalizacja</button>

      <button class="logout-btn" id="logoutBtn">Wyloguj</button>


    </div>
  </div>




  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      getDoc, 
      setDoc,
      updateDoc 
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.appspot.com",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);


        // Zmienne globalne
    let userSkills = {};
    let currentUserId = null;
    let allUsers = [];
    let isGamificationView = false;
    let usersData = {};
    let currentUserData = null;


    // Struktura drzewka umiejętności
    const SKILL_TREE = [
      {
        id: "toprock",
        name: "Toprock",
        desc: "Podstawowe kroki wykonywane na stojąco",
        level: "Poziom podstawowy",
        branches: [
          {
            direction: "left",
            skills: [
              { id: "basic-toprock", name: "Basic Toprock", level: "Poziom 1" },
              { id: "indian-step", name: "Indian Step", level: "Poziom 1", req: ["basic-toprock"], videoUrl: "https://www.youtube-nocookie.com/embed/xOXyKlhGiLE?si=hAqhz4vdzQxmLcXD" },
              { id: "side-step", name: "Side Step", level: "Poziom 2", req: ["indian-step"] },
              { id: "crossover-step", name: "Crossover Step", level: "Poziom 2", req: ["side-step"] },
              { id: "advanced-toprock", name: "Zaawansowane Toprock", level: "Poziom 3", req: ["crossover-step"] }
            ]
          }
        ]
      },
      {
        id: "footwork",
        name: "Footwork",
        desc: "Ruchy wykonywane blisko ziemi",
        level: "Poziom średniozaawansowany",
        branches: [
          {
            direction: "right",
            skills: [
              { id: "basic-6step", name: "6-step", level: "Poziom 1" },
              { id: "cc", name: "CC (Kick-outs)", level: "Poziom 1", req: ["basic-6step"]},
              { id: "3step", name: "3-step", level: "Poziom 2", req: ["basic-6step"], videoUrl: "https://www.youtube-nocookie.com/embed/xOXyKlhGiLE?si=hAqhz4vdzQxmLcXD"  },
              { id: "coffee-grinder", name: "Coffee Grinder", level: "Poziom 2", req: ["cc"] },
              { id: "footwork-combos", name: "Kombinacje", level: "Poziom 3", req: ["3step","coffee-grinder"] }
            ]
          }
        ]
      },
      {
        id: "freezes",
        name: "Freezy",
        desc: "Pozycje zatrzymania w tańcu",
        level: "Poziom zaawansowany",
        branches: [
          {
            direction: "left",
            skills: [
              { id: "baby-freeze", name: "Baby Freeze", level: "Poziom 1" },
              { id: "chair-freeze", name: "Chair Freeze", level: "Poziom 1", req: ["baby-freeze"] },
              { id: "airchair", name: "Airchair", level: "Poziom 2", req: ["chair-freeze"] },
              { id: "handstand-freeze", name: "Handstand Freeze", level: "Poziom 2", req: ["baby-freeze"] },
              { id: "combo-freezes", name: "Kombinacje Freezów", level: "Poziom 3", req: ["airchair","handstand-freeze"] }
            ]
          }
        ]
      },
      {
        id: "powermoves",
        name: "Powermoves",
        desc: "Dynamiczne ruchy wymagające siły",
        level: "Poziom ekspert",
        branches: [
       
          {
            direction: "right",
            skills: [
              { id: "backspin", name: "Backspin", level: "Poziom 1" },
              { id: "windmill", name: "Windmill", level: "Poziom 1", req: ["backspin"] },
              { id: "flare", name: "Flare", level: "Poziom 2", req: ["windmill"] },
              { id: "headspin", name: "Headspin", level: "Poziom 2", req: ["windmill"] },
              { id: "airflare", name: "Airflare", level: "Poziom 3", req: ["flare","headspin"] }
            ]
          }
        ]
      },
      {
        id: "style",
        name: "Styl i muzykalność",
        desc: "Rozwijanie własnego stylu",
        level: "Poziom mistrzowski",
        branches: [
          {
            direction: "left",
            skills: [
              { id: "rhythm", name: "Czucie rytmu", level: "Poziom 1" },
              { id: "musicality", name: "Muzykalność", level: "Poziom 2", req: ["rhythm"] },
              { id: "transitions", name: "Płynne przejścia", level: "Poziom 2", req: ["musicality"] },
              { id: "personal-style", name: "Własny styl", level: "Poziom 3", req: ["transitions"] }
            ]
          }
        ]
      }
    ];



    // Referencje do elementów DOM
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const skillTree = document.getElementById('skillTree');



    // Przełączanie między formularzami
    document.getElementById('show-register').addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      registerError.textContent = '';
    });

    document.getElementById('show-login').addEventListener('click', () => {
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
      loginError.textContent = '';
    });

    // Logowanie
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginError.textContent = '';
      } catch (error) {
        console.error('Błąd logowania:', error);
        loginError.textContent = getAuthErrorMessage(error.code);
      }
    });

    // Rejestracja
    document.getElementById('register-btn').addEventListener('click', async () => {
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      if (!name) {
        registerError.textContent = 'Podaj imię i nazwisko';
        return;
      }
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Utwórz dokument użytkownika w Firestore
        await setDoc(doc(db, "users", user.uid), {
          name: name,
          email: email,
          role: "user",
          skills: {},
          createdAt: new Date()
        });
        
        registerError.textContent = '';
      } catch (error) {
        console.error('Błąd rejestracji:', error);
        registerError.textContent = getAuthErrorMessage(error.code);
      }
    });

    // Wylogowanie
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error('Błąd wylogowania:', error);
      }
    });

    // Obserwuj stan autentykacji
   // Obserwuj stan autentykacji
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // Użytkownik zalogowany
    currentUserId = user.uid;
    authContainer.style.display = 'none';
    appContainer.style.display = 'block';
    
    // Pobierz dane użytkownika
    const userDoc = await getDoc(doc(db, "users", user.uid));
    currentUserData = userDoc.exists() ? userDoc.data() : {};
    
    // Ustaw informacje o użytkowniku
    userAvatar.textContent = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
    userName.textContent = currentUserData.name || user.email;
    
    // Załaduj umiejętności użytkownika
    await loadUserSkills();
    renderSkillTree();
    
    // Załaduj wszystkich użytkowników
    await loadAllUsers();
  } else {
    // Użytkownik wylogowany
    currentUserId = null;
    currentUserData = null;
    authContainer.style.display = 'block';
    appContainer.style.display = 'none';
  }
});

    // Załaduj umiejętności użytkownika z Firestore
// Załaduj umiejętności użytkownika z Firestore
async function loadUserSkills() {
  if (!currentUserId) return;
  
  try {
    const userDoc = await getDoc(doc(db, "users", currentUserId));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      userSkills = userData.skills || {};
      usersData[currentUserId] = userData; // Zapisz dane bieżącego użytkownika
    } else {
      userSkills = {};
    }
  } catch (error) {
    console.error("Błąd ładowania umiejętności:", error);
    userSkills = {};
  }
}

// Funkcja do renderowania drzewka
function renderSkillTree() {
  skillTree.innerHTML = '';

  SKILL_TREE.forEach((category) => {
    const levelContainer = document.createElement('div');
    levelContainer.className = 'tree-level';

    // --- KATEGORIA GŁÓWNA ---
    const mainSkill = document.createElement('div');
    mainSkill.className = 'main-skill';
    mainSkill.innerHTML = `<div class="skill-name">${category.name}</div>`;

    // --- NOWY STYL DLA KATEGORII ---
    mainSkill.style.cssText = `
      font-size: 20px;           /* większy napis */
      font-weight: 700;
      padding: 20px 24px;        /* większe kafelki */
      border: 2px solid black;   
      background: white;          /* białe tło */
      color: black;               /* czarny tekst */
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    `;

    levelContainer.appendChild(mainSkill);

    // --- KONTAINER NA UMIEJĘTNOŚCI ---
    const skillsContainer = document.createElement('div');
    skillsContainer.className = 'skills-container hidden';
    skillsContainer.style.display = 'flex';
    skillsContainer.style.flexDirection = 'column';
    skillsContainer.style.gap = '12px';
    skillsContainer.style.marginTop = '12px';

    let highestLevel = 0;

    category.branches.forEach(branch => {
      branch.skills.forEach(skill => {
        let userLevel = userSkills[skill.id] || 0;

        // Sprawdź wymagania: jeśli któryś z wymaganych skill.id nie został odblokowany, level = 0
        if (skill.req && skill.req.some(reqId => !userSkills[reqId] || userSkills[reqId] === 0)) {
          userLevel = 0;
        }

        // Aktualizuj najwyższy poziom kategorii (tylko dla poziomów 1-2)
        if (userLevel === 1 || userLevel === 2) {
          if (userLevel > highestLevel) highestLevel = userLevel;
        }

        const skillElement = document.createElement('div');

        // Jeśli poziom 0 lub 3 -> kłódka
        if (userLevel === 0 || userLevel === 3) {
          skillElement.className = 'branch-skill level0';
          skillElement.innerHTML = `<i class="fas fa-lock"></i>`;
          skillElement.style.display = "flex";
          skillElement.style.alignItems = "center";
          skillElement.style.justifyContent = "center";
          skillElement.style.height = "60px";
        } else {
          // Odblokowane poziomy 1 i 2
          skillElement.className = `branch-skill level${userLevel}`;
          skillElement.innerHTML = `<div class="skill-name">${skill.name}</div>`;

          // Ikona wideo jeśli jest
          if (skill.videoUrl) {
            const videoIcon = document.createElement('i');
            videoIcon.className = 'fab fa-youtube';
            videoIcon.style.position = 'absolute';
            videoIcon.style.top = '8px';
            videoIcon.style.right = '8px';
            videoIcon.style.fontSize = '20px';
            videoIcon.style.color = '#ff0000';
            videoIcon.style.cursor = 'pointer';
            videoIcon.title = 'Zobacz film';
            videoIcon.addEventListener('click', (e) => {
              e.stopPropagation();
              window.open(skill.videoUrl, '_blank');
            });
            skillElement.appendChild(videoIcon);
          }
        }

        skillElement.style.position = 'relative';
        skillElement.style.padding = '12px';
        skillElement.style.borderRadius = '8px';
        skillElement.style.fontWeight = '600';
        skillElement.style.boxShadow = '0 1px 4px rgba(0,0,0,0.15)';

        skillsContainer.appendChild(skillElement);
      });
    });

    mainSkill.addEventListener('click', () => {
      skillsContainer.classList.toggle('hidden');
    });

    levelContainer.appendChild(skillsContainer);
    skillTree.appendChild(levelContainer);
  });

  updateProgress();
}



// Aktualizuj pasek postępu (fioletowe ignorowane)
function updateProgress() {
  const totalSkills = SKILL_TREE.reduce((total, category) => {
    const skillsInCategory = category.branches.reduce((branchTotal, branch) => {
      // Liczymy tylko umiejętności poziomu 1 i 2
      return branchTotal + branch.skills.filter(skill => skill.level !== "Poziom 3").length;
    }, 0);
    return total + skillsInCategory + 1; // +1 za kategorię
  }, 0);

  const unlockedSkills = Object.entries(userSkills)
    .filter(([skillId, level]) => {
      const skill = SKILL_TREE.flatMap(c => c.branches.flatMap(b => b.skills))
                     .find(s => s.id === skillId);
      return skill && skill.level !== "Poziom 3" && level > 0;
    }).length;

  const progressPercent = (unlockedSkills / totalSkills) * 100;

  document.getElementById('progressFill').style.width = `${progressPercent}%`;
  document.getElementById('progressText').textContent = `${unlockedSkills}/${totalSkills} umiejętności`;
}


    
    // Funkcja do tłumaczenia kodów błędów Firebase
    function getAuthErrorMessage(errorCode) {
      switch (errorCode) {
        case 'auth/email-already-in-use':
          return 'Ten adres email jest już używany.';
        case 'auth/invalid-email':
          return 'Nieprawidłowy adres email.';
        case 'auth/operation-not-allowed':
          return 'Operacja nie jest dozwolona.';
        case 'auth/weak-password':
          return 'Hasło jest zbyt słabe. Użyj co najmniej 6 znaków.';
        case 'auth/user-disabled':
          return 'Konto zostało wyłączone.';
        case 'auth/user-not-found':
          return 'Nie znaleziono użytkownika.';
        case 'auth/wrong-password':
          return 'Nieprawidłowe hasło.';
        default:
          return 'Wystąpił nieznany błąd. Spróbuj ponownie.';
      }
    }
    
    // Funkcja zwracająca tekst dla poziomu umiejętności
    function getLevelText(level) {
      switch(level) {
        case 1: return "Poziom 1";
        case 2: return "Poziom 2";
        default: return "Nieokreślony poziom";
      }
    }

    


// Funkcja do ładowania wszystkich użytkowników
// Funkcja do ładowania wszystkich użytkowników
async function loadAllUsers() {
  try {
    const usersSnapshot = await getDocs(collection(db, "users"));
    allUsers = [];
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      usersData[doc.id] = userData;
      
      // Wyklucz obecnego użytkownika i adminów
      if (doc.id !== currentUserId && userData.role !== 'admin') {
        allUsers.push({
          id: doc.id,
          ...userData
        });
      }
    });
  } catch (error) {
    console.error("Błąd ładowania użytkowników:", error);
  }
}

// Funkcja do renderowania kafelków użytkowników
function renderUsersGrid() {
  const usersGrid = document.getElementById('users-grid');
  usersGrid.innerHTML = '';

  allUsers.forEach(user => {
    const userCard = document.createElement('div');
    userCard.className = 'user-card';
    userCard.style.cssText = `
      background: #161b22;
      padding: 15px;
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.2s;
      border: 1px solid #30363d;
      color: #e6edf3;
    `;

    const userSkillsData = user.skills || {};

    // Całkowity procent
    const totalPercent = calculateProgress(userSkillsData);

    // Procent dla każdej dziedziny
    const categoryPercents = SKILL_TREE.map(category => {
      const skillsInCategory = category.branches.flatMap(b => b.skills);
      const unlockedCount = skillsInCategory.filter(skill => {
        const level = userSkillsData[skill.id] || 0;
        return level === 1 || level === 2; // tylko poziomy odblokowane
      }).length;
      return {
        name: category.name,
        percent: Math.round((unlockedCount / skillsInCategory.length) * 100)
      };
    });

    // Tworzenie HTML kategorii z wyróżnieniem
    let categoryHTML = '';
    categoryPercents.forEach(cat => {
      categoryHTML += `
        <div style="
          font-size: 14px; 
          font-weight: 700; 
          color: #ffffff; 
          background: #30363d; 
          padding: 6px 8px; 
          margin-bottom: 4px; 
          border-radius: 8px;
        ">
          ${cat.name}: ${cat.percent}%
        </div>
      `;
    });

    userCard.innerHTML = `
      <h3 style="margin: 5px 0; color: #00d4ff;">${user.name || 'Użytkownik'}</h3>
      <div style="font-size: 14px; margin-bottom: 8px;">Całkowity postęp: ${totalPercent}%</div>
      ${categoryHTML}
    `;

    usersCardEvents(userCard, user.id, user.name);

    usersGrid.appendChild(userCard);
  });
}

// Funkcja do obsługi kliknięcia i efektów hover
function usersCardEvents(card, userId, userName) {
  card.addEventListener('click', () => {
    viewUserSkills(userId, userName);
  });

  card.addEventListener('mouseenter', () => {
    card.style.transform = 'translateY(-5px)';
    card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
  });

  card.addEventListener('mouseleave', () => {
    card.style.transform = 'translateY(0)';
    card.style.boxShadow = 'none';
  });
}

// Funkcja do obliczenia całkowitego postępu
function calculateProgress(skills) {
  const totalSkills = SKILL_TREE.reduce((total, category) => {
    const count = category.branches.flatMap(b => b.skills).length;
    return total + count;
  }, 0);

  const unlockedSkills = Object.values(skills).filter(level => level === 1 || level === 2).length;
  return Math.round((unlockedSkills / totalSkills) * 100);
}


// Funkcja do podglądu umiejętności innego użytkownika
// Funkcja do podglądu umiejętności innego użytkownika
async function viewUserSkills(userId, userName) {
  try {
    // Ukryj grywalizację i pokaż drzewko
    document.getElementById('gamification-section').style.display = 'none';
    document.getElementById('skillTree').style.display = 'block';
    isGamificationView = false;
    
    const userDoc = await getDoc(doc(db, "users", userId));
    if (userDoc.exists()) {
      userSkills = userDoc.data().skills || {};
      document.getElementById('userName').textContent = `${userName} (podgląd)`;
      renderSkillTree();
      
      // Dodaj przycisk powrotu (jeśli jeszcze nie istnieje)
      let backButton = document.getElementById('backButton');
      if (!backButton) {
        backButton = document.createElement('button');
        backButton.id = 'backButton';
        backButton.textContent = 'Powrót do mojego widoku';
        backButton.style.cssText = `
          padding: 10px 15px;
          background: #ff6b6b;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          margin: 10px 0;
          width: 100%;
        `;
        
        backButton.onclick = async () => {
          await loadUserSkills();
          document.getElementById('userName').textContent = currentUserData?.name || 'Użytkownik';
          renderSkillTree();
          backButton.remove();
        };
        
        const userPanel = document.querySelector('.user-panel');
        userPanel.appendChild(backButton);
      }
    }
  } catch (error) {
    console.error("Błąd ładowania umiejętności użytkownika:", error);
  }
}




document.getElementById('gamificationBtn').addEventListener('click', async () => {
  if (!isGamificationView) { // jeśli nie jesteśmy jeszcze w widoku grywalizacji
    isGamificationView = true;
    await loadAllUsers();
    
    document.getElementById('gamification-section').style.display = 'block';
    document.getElementById('skillTree').style.display = 'none';

    // Usuń istniejący przycisk powrotu, jeśli jest
    const oldBackButton = document.getElementById('backButton');
    if (oldBackButton) oldBackButton.remove();

    // Dodaj przycisk powrotu
    // Dodaj przycisk powrotu
    const backButton = document.createElement('button');
    backButton.id = 'backButton';
    backButton.textContent = 'Powrót do moich umiejętności';
    backButton.style.cssText = `
      padding: 10px 15px;
      background: white;
      color: black;
      border: 2px solid black;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 0;
      width: 100%;
      font-weight: 600;
      transition: all 0.3s ease;
    `;
    backButton.onmouseenter = () => {
      backButton.style.background = '#f0f0f0';
    };
    backButton.onmouseleave = () => {
      backButton.style.background = 'white';
    };
    backButton.onclick = async () => {
      await loadUserSkills(); // załaduj własne umiejętności
      document.getElementById('userName').textContent = currentUserData?.name || 'Użytkownik';
      renderSkillTree();
      document.getElementById('gamification-section').style.display = 'none';
      document.getElementById('skillTree').style.display = 'block';
      backButton.remove();
      isGamificationView = false;
    };

    document.querySelector('.user-panel').appendChild(backButton);

    renderUsersGrid();
  }
});


  </script>

  <!-- W app-container, pod header ale przed skill-tree -->
<div id="gamification-section" style="margin: 20px 0; display: none;">
  <h2>Grywalizacja</h2>
  <div id="users-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;"></div>
</div>



</body>
</html>
